<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS | Terminal de Inteligencia</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí†</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'nexus-bg': '#0d1117',
                        'nexus-card': '#161b22',
                        'nexus-border': '#30363d',
                        'nexus-text': '#c9d1d9',
                        'nexus-green': '#3fb950',
                        'nexus-red': '#f85149',
                        'nexus-blue': '#58a6ff',
                        'nexus-yellow': '#d29922',
                        'nexus-purple': '#a371f7'
                    },
                    fontFamily: {
                        'mono': ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
            /* Evita el scroll horizontal en m√≥vil */
            overflow-x: hidden; 
        }
        
        @keyframes price-up {
            0% { background-color: rgba(63, 185, 80, 0.3); }
            100% { background-color: transparent; }
        }
        
        @keyframes price-down {
            0% { background-color: rgba(248, 81, 73, 0.3); }
            100% { background-color: transparent; }
        }
        
        .flash-green { animation: price-up 0.5s ease-out; }
        .flash-red { animation: price-down 0.5s ease-out; }
        
        /* Scrollbar m√°s fino */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #484f58; }
        
        .glow-green { box-shadow: 0 0 20px rgba(63, 185, 80, 0.1); }
        .glow-blue { box-shadow: 0 0 20px rgba(88, 166, 255, 0.1); }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    
    <header class="bg-nexus-card border-b border-nexus-border px-4 py-4 md:px-6 sticky top-0 z-50 shadow-lg shadow-black/50">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            
            <div class="w-full md:w-auto flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üí†</span>
                    <h1 class="text-2xl font-bold text-nexus-blue tracking-tighter">NEXUS</h1>
                    <span class="text-[10px] text-nexus-text/50 border border-nexus-border px-1.5 rounded bg-nexus-bg">v1.0</span>
                </div>
                <div id="connection-status-mobile" class="md:hidden w-2 h-2 rounded-full bg-nexus-green animate-pulse"></div>
            </div>
            
            <nav class="flex items-center space-x-6 text-sm md:text-base">
                <a href="/" class="text-nexus-blue border-b-2 border-nexus-blue pb-0.5">Dashboard</a>
                <a href="/predictions" class="text-nexus-text/60 hover:text-nexus-text transition">Predicciones</a>
                <a href="/portfolio" class="text-nexus-text/60 hover:text-nexus-text transition">Cartera</a>
            </nav>
            
            <div class="flex items-center space-x-4 w-full md:w-auto justify-center md:justify-end">
                <div id="user-points" class="flex items-center space-x-2 bg-nexus-bg px-4 py-2 rounded-full border border-nexus-border w-full md:w-auto justify-center">
                    <span class="text-nexus-yellow">‚≠ê</span>
                    <span class="text-nexus-text font-bold tracking-wider">--</span>
                    <span class="text-nexus-text/50 text-xs uppercase">pts</span>
                </div>
                <div id="connection-status" class="hidden md:block w-3 h-3 rounded-full bg-nexus-green" title="Conectado"></div>
            </div>
        </div>
    </header>
    
    <main class="flex-grow max-w-7xl mx-auto px-4 md:px-6 py-6 w-full">
        
        <div class="flex flex-col sm:flex-row items-center justify-between mb-8 gap-4 bg-nexus-card/50 p-3 rounded-xl border border-nexus-border/50">
            <div class="flex items-center space-x-2 text-nexus-text/60 text-xs md:text-sm">
                <span>üì° √öltima se√±al:</span>
                <span id="last-update" class="text-nexus-green font-mono">Sincronizando...</span>
            </div>
            <button onclick="refreshPrices()" class="w-full sm:w-auto flex items-center justify-center space-x-2 bg-nexus-blue/10 hover:bg-nexus-blue/20 text-nexus-blue px-4 py-2 rounded-lg border border-nexus-blue/30 transition text-sm font-semibold active:scale-95">
                <svg id="refresh-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>Actualizar Mercado</span>
            </button>
        </div>
        
        <section class="mb-10">
            <h2 class="text-sm font-semibold text-nexus-text/50 uppercase tracking-widest mb-4">Mercados en Vivo</h2>
            <div id="price-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-3">
                <div class="bg-nexus-card border border-nexus-border rounded-lg p-4 animate-pulse h-24"></div>
                <div class="bg-nexus-card border border-nexus-border rounded-lg p-4 animate-pulse h-24 hidden sm:block"></div>
                <div class="bg-nexus-card border border-nexus-border rounded-lg p-4 animate-pulse h-24 hidden lg:block"></div>
            </div>
        </section>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <section class="lg:col-span-2 bg-nexus-card border border-nexus-border rounded-xl p-5 md:p-6 glow-blue relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-nexus-blue/5 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
                
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-bold text-nexus-text flex items-center gap-2">
                        üß† Predicciones IA
                    </h2>
                    <span class="text-[10px] text-nexus-purple bg-nexus-purple/10 border border-nexus-purple/20 px-2 py-1 rounded-full font-mono">ENSEMBLE v2.1</span>
                </div>
                
                <div id="predictions-container" class="space-y-3">
                    <div class="text-center py-8 text-nexus-text/40 animate-pulse">Cargando inteligencia...</div>
                </div>
            </section>
            
            <section class="bg-nexus-card border border-nexus-border rounded-xl p-5 md:p-6">
                <h2 class="text-lg font-bold text-nexus-text mb-6">Actividad</h2>
                
                <div id="activity-feed" class="space-y-4 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                    <div class="flex items-start space-x-3 pb-3 border-b border-nexus-border/50">
                        <div class="w-8 h-8 bg-nexus-green/10 rounded-lg flex items-center justify-center flex-shrink-0 text-nexus-green">+</div>
                        <div>
                            <p class="text-nexus-text text-sm font-medium">Predicci√≥n BTC correcta</p>
                            <p class="text-nexus-text/40 text-xs">Hace 2 horas</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-3 pb-3 border-b border-nexus-border/50">
                        <div class="w-8 h-8 bg-nexus-yellow/10 rounded-lg flex items-center justify-center flex-shrink-0 text-nexus-yellow">‚≠ê</div>
                        <div>
                            <p class="text-nexus-text text-sm font-medium">+15 Puntos (Bono Diario)</p>
                            <p class="text-nexus-text/40 text-xs">Hace 4 horas</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <section class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
            <button onclick="watchAd()" class="group bg-nexus-card hover:bg-nexus-card/80 border border-nexus-border hover:border-nexus-blue/50 rounded-xl p-5 text-left transition-all active:scale-[0.98]">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-2xl filter grayscale group-hover:grayscale-0 transition">üì∫</span>
                    <span class="text-xs text-nexus-green bg-nexus-green/10 px-2 py-0.5 rounded-full">+10 pts</span>
                </div>
                <h3 class="font-bold text-nexus-text group-hover:text-nexus-blue">Ver Anuncio</h3>
                <p class="text-xs text-nexus-text/50 mt-1">Apoya la plataforma y gana cr√©ditos</p>
            </button>
            
            <button onclick="window.location.href='/predictions'" class="group bg-nexus-card hover:bg-nexus-card/80 border border-nexus-border hover:border-nexus-purple/50 rounded-xl p-5 text-left transition-all active:scale-[0.98]">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-2xl filter grayscale group-hover:grayscale-0 transition">üé≤</span>
                    <span class="text-xs text-nexus-purple bg-nexus-purple/10 px-2 py-0.5 rounded-full">Jugar</span>
                </div>
                <h3 class="font-bold text-nexus-text group-hover:text-nexus-purple">Apostar Puntos</h3>
                <p class="text-xs text-nexus-text/50 mt-1">Desaf√≠a a la IA del mercado</p>
            </button>
            
            <button onclick="showWithdrawalModal()" class="group bg-nexus-card hover:bg-nexus-card/80 border border-nexus-border hover:border-nexus-green/50 rounded-xl p-5 text-left transition-all active:scale-[0.98]">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-2xl filter grayscale group-hover:grayscale-0 transition">üí∏</span>
                    <span class="text-xs text-nexus-green bg-nexus-green/10 px-2 py-0.5 rounded-full">Cashout</span>
                </div>
                <h3 class="font-bold text-nexus-text group-hover:text-nexus-green">Retirar Fondos</h3>
                <p class="text-xs text-nexus-text/50 mt-1">PayPal o Bonus Kraken</p>
            </button>
        </section>
    </main>
    
    <footer class="border-t border-nexus-border mt-8 py-6 bg-nexus-bg/50">
        <div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row items-center justify-between text-nexus-text/40 text-xs gap-4">
            <p>&copy; 2026 NEXUS Intelligence.</p>
            <div class="flex items-center space-x-4">
                <span id="server-status" class="flex items-center gap-2">
                    System: <span class="text-nexus-green">Online</span>
                </span>
            </div>
        </div>
    </footer>
    
    <script>
        const API_BASE = '';
        const UPDATE_INTERVAL = 10000;
        const USER_ID = 1; 
        let previousPrices = {};
        
        const SYMBOLS = {
            'BTC-USD': { name: 'Bitcoin', short: 'BTC', color: 'nexus-yellow' },
            'ETH-USD': { name: 'Ethereum', short: 'ETH', color: 'nexus-purple' },
            'XRP-USD': { name: 'Ripple', short: 'XRP', color: 'nexus-blue' },
            'GLD': { name: 'Gold', short: 'GLD', color: 'nexus-yellow' },
            'DX-Y.NYB': { name: 'USD Idx', short: 'DXY', color: 'nexus-green' }
        };
        
        function formatPrice(price) {
            if (price >= 1000) return '$' + price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (price >= 1) return '$' + price.toFixed(2);
            return '$' + price.toFixed(4);
        }
        
        function formatChange(change) {
            const sign = change >= 0 ? '+' : '';
            return sign + change.toFixed(2) + '%';
        }
        
        async function fetchPrices() {
            try {
                const response = await fetch(`${API_BASE}/api/prices/all`);
                const data = await response.json();
                return data.prices;
            } catch (error) {
                console.error('Error:', error);
                return null;
            }
        }
        
        async function fetchPrediction(symbol) {
            try {
                const response = await fetch(`${API_BASE}/api/prediction/${symbol}`);
                return await response.json();
            } catch (error) { return null; }
        }
        
        function updatePriceGrid(prices) {
            const grid = document.getElementById('price-grid');
            grid.innerHTML = '';
            
            for (const [symbol, data] of Object.entries(prices)) {
                if (data.error) continue;
                
                const info = SYMBOLS[symbol] || { name: symbol, short: symbol, color: 'nexus-text' };
                const isUp = data.change_percent >= 0;
                const changeColor = isUp ? 'text-nexus-green' : 'text-nexus-red';
                
                // Detecci√≥n de flash
                let flashClass = '';
                if (previousPrices[symbol]) {
                    if (data.price > previousPrices[symbol]) flashClass = 'flash-green';
                    else if (data.price < previousPrices[symbol]) flashClass = 'flash-red';
                }
                previousPrices[symbol] = data.price;
                
                // Card m√°s compacta para m√≥vil
                const card = document.createElement('div');
                card.className = `bg-nexus-card border border-nexus-border rounded-lg p-3 md:p-4 hover:border-nexus-blue/50 transition cursor-pointer select-none ${flashClass}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-${info.color} font-bold text-sm md:text-base">${info.short}</span>
                        <span class="${changeColor} text-xs font-mono bg-${isUp ? 'green' : 'red'}-500/10 px-1.5 rounded">${formatChange(data.change_percent)}</span>
                    </div>
                    <p class="text-nexus-text text-lg md:text-xl font-bold tracking-tight">${formatPrice(data.price)}</p>
                `;
                grid.appendChild(card);
            }
        }
        
        async function updatePredictions() {
            const container = document.getElementById('predictions-container');
            container.innerHTML = ''; // Limpiar loader
            const symbols = ['BTC-USD', 'ETH-USD', 'XRP-USD'];
            
            for (const symbol of symbols) {
                const pred = await fetchPrediction(symbol);
                if (!pred) continue;
                
                const isUp = pred.direction === 'SUBIR';
                const colorClass = isUp ? 'text-nexus-green' : 'text-nexus-red';
                const bgClass = isUp ? 'bg-nexus-green/5 border-nexus-green/20' : 'bg-nexus-red/5 border-nexus-red/20';
                const arrow = isUp ? '‚Üó' : '‚Üò';
                
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 md:p-4 rounded-lg border ${bgClass} transition hover:bg-opacity-50`;
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 md:w-10 md:h-10 bg-nexus-bg rounded-lg border border-nexus-border flex items-center justify-center font-bold text-xs md:text-sm text-nexus-text">
                            ${symbol.split('-')[0]}
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="text-nexus-text font-bold text-sm md:text-base">${symbol}</span>
                            </div>
                            <span class="text-[10px] md:text-xs text-nexus-text/50">Confianza: ${pred.confidence.toFixed(0)}%</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="${colorClass} font-bold text-sm md:text-base flex items-center justify-end gap-1">
                            ${pred.direction} ${arrow}
                        </div>
                        <div class="text-[10px] md:text-xs text-nexus-text/40 font-mono">${formatPrice(pred.current_price)}</div>
                    </div>
                `;
                container.appendChild(div);
            }
        }
        
        async function updateUserPoints() {
            try {
                // Endpoint corregido que definimos en Python
                const response = await fetch(`${API_BASE}/api/user/${USER_ID}/summary`);
                if (response.ok) {
                    const data = await response.json();
                    const ptsElement = document.querySelector('#user-points span:nth-child(2)');
                    ptsElement.textContent = data.points || data.nexus_points || 0; // Soporte para ambos nombres
                }
            } catch (e) { console.log("Usuario offline"); }
        }
        
        async function refreshPrices() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('animate-spin');
            
            const prices = await fetchPrices();
            if (prices) updatePriceGrid(prices);
            
            await updatePredictions();
            await updateUserPoints();
            
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString('es-ES');
            
            setTimeout(() => icon.classList.remove('animate-spin'), 500);
        }

        // Acciones dummy
        function watchAd() { alert("üì∫ Simulando video publicitario...\n+10 Puntos acreditados."); updateUserPoints(); }
        function showWithdrawalModal() { alert("üè¶ SISTEMA DE RETIRO:\n\n‚Ä¢ Opci√≥n A: PayPal (Comisi√≥n 10%)\n‚Ä¢ Opci√≥n B: Kraken Partner (BONUS +5%)\n\nRecomendamos Kraken para maximizar ganancias."); }
        
        document.addEventListener('DOMContentLoaded', () => {
            refreshPrices();
            setInterval(refreshPrices, UPDATE_INTERVAL);
        });
    </script>
</body>
</html>